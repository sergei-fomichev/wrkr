<!DOCTYPE html>
<html lang="en">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leap</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
	
      body {
        line-height: 2em;
        font-size: 12pt;
        font-family: Helvetica;
      }
	  #output{
		  font-size: 18pt;
	  }
	  .jumbotron{
		  padding: 30px 0;
	  } 
	  .progress{
		  margin-bottom: 0px;
	  }
	  canvas{
		  border: 1px solid;
	  }
	  circle {
	    fill: #ddd;
	    stroke: #0074d9;
	    stroke-width: 50;
	    stroke-dasharray: 0 158;
	    transition: stroke-dasharray .3s ease;
		  
	  }

	  svg {
		transform: rotate(-90deg);
	    background: #ddd;
	    border-radius: 50%;
	  }
	  
    </style>

  </head>

  <body>
	  <div class="container">
	  	  <div class="jumbotron">
			  <h2>WRKR</h2>
	  		  <p>Welcome to wrist-fingers exerciser. You need a Leap Motion device to proceed. To start the daily exercise hit the button below.</p>
	          <p>
	            <a class="btn btn-lg btn-primary" href="#" role="button" id="start-wrkr">Start exercise</a>
	          </p>
	      </div>
	  	<div class="row">
	  		<div class="col-md-4">
					  <button id="twistsH" type="button" class="action list-group-item">Twists Horizontal</button>	  
					  <!-- ><button id="twistsV" type="button" class="action list-group-item">Twists Vertical</button> -->
				<!-- <button id="fist" class="action">Fist stretch</button> -->
					  <button id="knuckle_bend" type="button" class="action list-group-item">Knuckle Bend</button>
					  <button id="thumb_bend" type="button" class="action list-group-item">Thumb Bend</button>
					  <button id="circle" type="button" class="action list-group-item">Circle</button>
	  		</div>
			<div class="col-md-4">
				<p>Blah Blah Blah</p>
			</div>
			<div class="col-md-4">
				<div>You have done: <span id="exerciseProgress"></span>/5</div>
				
				<canvas id="Circle" width="200" height="200"></canvas>
				<!--
				<svg width="100" height="100" class="chart">
				    <circle r="25" cx="50" cy="50" id="pie"/>
				  </svg>
					-->
			</div>
	  	</div>
	  </div>
	  <div class="container-fluid">
		<div id="output"></div>
	  </div>
	  

<footer>
	<div class="progress navbar-fixed-bottom">
	  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
	    <span class="sr-only"></span>
	  </div>
	</div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="http://js.leapmotion.com/leap-0.6.3.js"></script>
<script>


	var counter = document.getElementById("exerciseProgress");
	var canvas = document.getElementById("Circle");
	var output = document.getElementById("output");
	var circleImg = new Image();
	circleImg.src = "img/CircleGesture.png";
	$("#output").html(circleImg);
	
	var hand, finger;
	var extendedFingers = 0;
	var wristNormal, oldNormal = 0;
	var repDone = 1;
	var exerciseCounter = 0;
	var exercise;

	var ctx = canvas.getContext('2d');
	var centerX = canvas.width / 2;
	var centerY = canvas.height / 2;
	var radius = 50;
	var amount = 0;
	var progressStep = 0.5;
	
	
	function draw_circle(){
	    ctx.beginPath(); 
		ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false); 
		ctx.fillStyle = 'white'; 
		ctx.fill;
		ctx.lineWidth = 5; 
		ctx.strokeStyle = '#000000';
	    ctx.stroke();
	}
	function clear(){
		amount = 0;
		ctx.clearRect(centerX - radius, centerY - radius, radius * 2, radius * 2);
	}
	function draw(){	
		counter.innerHTML = exerciseCounter; //digital counter
		
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
   		ctx.clip(); 
		ctx.fillStyle = '#13a8a4';
		if(amount !== exerciseCounter*20){
			amount += progressStep;
			ctx.fillRect(centerX - radius, centerY + radius, radius * 2, -amount);
		}
		
		
		
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
        ctx.lineWidth = 5;
        ctx.strokeStyle = '#000000';
 	    ctx.stroke();
		 
	}

 	draw_circle();
	
	var controller = new Leap.Controller({
	    enableGestures: true,
	    frameEventName: 'animationFrame'
	}), 
	callMuteRequestMade = false;
	

	$(".action").click(function(){
		exercise = this.id;
		exerciseCounter = 0;
	});
	
	$("#start-wrkr").click(function(){
			var curr_wrkr = $( ".action" ).first();
			$(curr_wrkr).addClass( "active" );
			exerciseCounter = 0;
			exercise = $(curr_wrkr).attr( "id" );
		
		
		    controller.loop(function(frame) {
    			if(exerciseCounter == 0){
    				clear();
					draw_circle();
    			}
				else if(exerciseCounter == 5){
					$(curr_wrkr).removeClass( "active" );
					$(curr_wrkr).addClass( "list-group-item-success");
					clear();
					draw_circle();
					
					find_wrkr();
				}
					
		    });
			
			function find_wrkr(){
				exerciseCounter = 0;
				
				next_wrkr = $(curr_wrkr).next();
				exercise = $(next_wrkr).attr( "id" );
				if(exercise === undefined){
					console.log("Done");
					return false;
				}
				$(next_wrkr).addClass( "active" );
				
				curr_wrkr = next_wrkr;
				
			}
			
			
			return false;

	});

			
	controller.on('frame', function(frame){
		for(i = 0, len = frame.hands.length; i < len; i++){
			hand = frame.hands[i];
			
		$(".progress-bar").attr({
			"aria-valuenow" : Math.round(hand.confidence*100),
			"style" : "width:" + Math.round(hand.confidence*100) + "%"  
		});
			////exercises here
			if(exercise == "twistsH"){
	
				wristNormal = Math.round(hand.palmNormal[1]);
				//console.log(wristNormal +","+ oldNormal);
				if(wristNormal !== oldNormal && wristNormal != -1){
					exerciseCounter += 0.5;
					oldNormal = wristNormal;
				}
				
				
			}
			/*else if(exercise == "twistsV"){
		
				wristNormal = Math.round(hand.palmNormal[2]);
				console.log(wristNormal +","+ oldNormal);
				if(wristNormal !== oldNormal && wristNormal != 1){
					exerciseCounter += 0.5;
					oldNormal = wristNormal;
				}
			
				
			}
				else if(exercise == "fist"){
				var fingerExt = 0; 
				for(j = 0, len1 = hand.fingers.length; j < len1; j++){
					finger = hand.fingers[j];
					if(finger.extended) 
						fingerExt ++;
				}
				if(fingerExt == 5){
					oldNormal = 1;
				}

				if(fingerExt <= 1 && hand.grabStrength == 1 && oldNormal == 1){
					exerciseCounter += 1;
					oldNormal = null;
				}
			}
					*/
			else if(exercise == "knuckle_bend"){
				var clawState = 0;
				for(j = 0; j < hand.fingers.length; j++){
					finger = hand.fingers[j];
					if(finger.type >= 1 && finger.type <=4 && finger.extended == true){
						clawState++;
					}
				}
				if(clawState == 4)
					repDone = 0;
				
				else if(clawState == 0 && repDone == 0){
					exerciseCounter++;
					repDone = 1;
				}
				
			}
			else if(exercise == "thumb_bend"){
			
				if(hand.thumb.extended == true){
					repDone = 0;
				}
				
				if(hand.thumb.extended == false && repDone == 0){
					exerciseCounter++;
					repDone = 1;
				}
	
			}
			else if(exercise == "circle"){
				var duration;
				frame.gestures.forEach(function(gesture){
					if(frame.valid && frame.gestures.length > 0){
						duration = gesture.duration;
						//counter.innerHTML = duration;
						
						duration /= 1000000;
						exerciseCounter = Math.round(duration);
						
					}
				
				
				});
			}
		}
	

		draw();
		//output.innerHTML = frameString;  
	  });
	  
	
	controller.connect();
	  
	 
    </script>

  </body>

</html>