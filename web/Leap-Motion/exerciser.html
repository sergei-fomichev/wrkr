<!DOCTYPE html>
<html lang="en">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leap</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
	
      body {
        line-height: 2em;
        font-size: 12pt;
        font-family: Helvetica;
      }
	  #output{
		  font-size: 18pt;
	  }
	  .jumbotron{
		  padding: 20px 0;
		  margin-bottom: 20px;
	  } 
	  .progress{
		  margin-bottom: 0px;
	  }
	  .hand{
		  border-radius: 6px;
		  margin: 0 15px 10px;
	  }
	  .hand>p{
	  	padding: 10px 0;
		margin: 0;
	  }
	  circle {
	    fill: #ddd;
	    stroke: #0074d9;
	    stroke-width: 50;
	    stroke-dasharray: 0 158;
	    transition: stroke-dasharray .3s ease;
		  
	  }

	  svg {
		transform: rotate(-90deg);
	    background: #ddd;
	    border-radius: 50%;
	  }
	  
    </style>

  </head>

  <body>
	  <div class="container">
	  	  <div class="jumbotron">
			  <h2>WRKR</h2>
	  		  <p>Welcome to wrist-fingers exerciser. You need a Leap Motion device to proceed. To start the daily exercise hit the button below.</p>
	          <p>
	            <a class="btn btn-lg btn-primary" href="#" role="button" id="start-wrkr">Start exercising</a>
	          </p>
	      </div>
		<div class="row">
			<div class="col-md-12 hand">
			</div>
		</div>  
	  	<div class="row">
	  		<div class="col-md-4">
					  <button id="twistsH" type="button" class="action list-group-item">Twists Horizontal</button>	  
					  <!-- ><button id="twistsV" type="button" class="action list-group-item">Twists Vertical</button> -->
					  <!-- <button id="fist" class="action">Fist stretch</button> -->
					  <button id="knuckle_bend" type="button" class="action list-group-item">Knuckle Bend</button>
					  <button id="thumb_bend" type="button" class="action list-group-item">Thumb Bend</button>
					  <button id="circle" type="button" class="action list-group-item">Circle</button>
	  		</div>
			<div class="col-md-5 exDescription">
				
			</div>
			<div class="col-md-3">
				<div>You have done: <span id="exerciseProgress"></span>/<span id="exerciseRepeats"></span></div>
				
				<canvas id="Circle" width="200" height="200"></canvas>
				<!--
				<svg width="100" height="100" class="chart">
				    <circle r="25" cx="50" cy="50" id="pie"/>
				  </svg>
					-->
			</div>
	  	</div>
	  </div>
	  <div class="container-fluid">
		<div id="output"></div>
	  </div>
	  

<footer>
	<div class="progress navbar-fixed-bottom">
	  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
	    <span class="sr-only"></span>
	  </div>
	</div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="http://js.leapmotion.com/leap-0.6.3.js"></script>
<script>


	var counter = document.getElementById("exerciseProgress");
	var canvas = document.getElementById("Circle");
	var output = document.getElementById("output");
	var circleImg = new Image();
	circleImg.src = "img/CircleGesture.png";

	var knuckleImg = new Image();
	knuckleImg.src = "img/knuckle.jpg";

	var thumbImg = new Image();
	thumbImg.src = "img/thumb.jpg";
	
	var twistsImg = new Image();
	twistsImg.src = "img/twists.jpg";

	
	var hand, finger;
	var handStatus;
	var extendedFingers = 0;
	var wristNormal, oldNormal = 0;
	var repDone = 1;
	var exerciseCounter = 0;
	var exerciseRepeats = 0;
	var exercise;
	var currWrkrDOM;

	var ctx = canvas.getContext('2d');
	var centerX = canvas.width / 2;
	var centerY = canvas.height / 2;
	var radius = 50;
	var amount = 0;
	var progressStep = 1;
	
	var controller = new Leap.Controller({
	    enableGestures: true,
	    frameEventName: 'animationFrame'
	}), 
	callMuteRequestMade = false;
	
	function draw_circle(){
	    ctx.beginPath(); 
		ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false); 
		ctx.fillStyle = 'white'; 
		ctx.fill;
		ctx.lineWidth = 5; 
		ctx.strokeStyle = '#000000';
	    ctx.stroke();
	}
	function clear(){
		amount = 0;
		ctx.clearRect(centerX - radius, centerY - radius, radius * 2, radius * 2);
	}
	function draw(){	
		counter.innerHTML = exerciseCounter; //digital counter
		
		
		
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
   		ctx.clip(); 
		ctx.fillStyle = '#5cb85c';
		

		
		if(amount !== exerciseCounter*(Math.round(100/exerciseRepeats))){ /////here is a thing with exercise repeats
			amount += progressStep;
			ctx.fillRect(centerX - radius, centerY + radius, radius * 2, -amount);
			//return false;
		}
		else{
			return true;
		}
		
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
        ctx.lineWidth = 5;
        ctx.strokeStyle = '#000000';
 	    ctx.stroke();
		

		 
	}
	
	
	var exercises = {
		twistsH : {
			name: "Palm twists",
			numRepeats: 5,
			text: "Rotate your forearm, so that your palm faces up and then down.",
			picture: twistsImg,
			exercise: function(){
				wristNormal = Math.round(hand.palmNormal[1]);
			//console.log(wristNormal +","+ oldNormal);
				if(wristNormal !== oldNormal && wristNormal != -1){
					exerciseCounter += 0.5;
					oldNormal = wristNormal;
				}
			}
		},
		knuckle_bend: {
			name: "Knuckle bend",
			numRepeats: 3,
			text: "Bend your fingers using the middle and end joints, but keep the knuckles straight.",
			picture: knuckleImg,
			exercise: function(){
				var clawState = 0;
				for(j = 0; j < hand.fingers.length; j++){
					finger = hand.fingers[j];
					if(finger.type >= 1 && finger.type <=4 && finger.extended == true){
						clawState++;
					}
				}
				if(clawState == 4)
					repDone = 0;
			
				else if(clawState == 0 && repDone == 0){
					exerciseCounter++;
					repDone = 1;
				}
			}
		},
		thumb_bend: {
			name: "Thumb bend",
			numRepeats: 5,
			text: "Move the thumb across the palm and back to the starting position.",
			picture: thumbImg,
			exercise: function(){
				if(hand.thumb.extended == true){
					repDone = 0;
				}
				
				if(hand.thumb.extended == false && repDone == 0){
					exerciseCounter++;
					repDone = 1;
				}
			}
		},
		circle: {
			name: "Draw a circle",
			numRepeats: 2,
			text: "Draw a circle with your picky finger.",
			picture: circleImg,
			exercise: function(frame){
				var duration;
				frame.gestures.forEach(function(gesture){
					if(frame.valid && frame.gestures.length > 0){
						duration = gesture.duration;
						//counter.innerHTML = duration;
						
						duration /= 1000000;
						exerciseCounter = Math.round(duration);	
					}
				});
			}
		},
		hand_type: ["Right", "Left"]
	}
	
	function next_wrkr(){
		exerciseCounter = 0;
		
		var nextWrkrDOM = $(currWrkrDOM).next();
		exercise = $(nextWrkrDOM).attr( "id" );
		if(exercise === undefined){
			$(".action").removeClass("list-group-item-success");
			handType = exercises.hand_type[1];
			$(".hand").html("<p>"+ handType +" hand</p>");
			exercise = Object.keys(exercises)[0];
		
			exerciseRepeats = exercises[exercise].numRepeats;
			$("#exerciseRepeats").text(exerciseRepeats);
			
			return false;
		}
		$(nextWrkrDOM).addClass( "active" );
		$(".exDescription").html("<h3>"+ exercises[exercise].name +"</h3><p>"+ exercises[exercise].text +"</p>");
		$(".exDescription").append(exercises[exercise].picture);
		exerciseRepeats = exercises[exercise].numRepeats;
		$("#exerciseRepeats").text(exerciseRepeats);
		
		
		currWrkrDOM = nextWrkrDOM;
		
	}

	$(".action").click(function(){
		exercise = this.id;
		$(this).addClass( "active" );
		exerciseCounter = 0;
	});
	
	$("#start-wrkr").click(function(){
		//for(var keys in exercises){
		//	console.log(exercises[keys].name);
		//}
		//console.log(Object.keys(exercises)[0]); //get key
		//console.log(exercises[Object.keys(exercises)[0]].name); //get value
		//console.log(exercises.hand_type[1]); // same value
		
		
		handType = exercises.hand_type[0];
		$(".hand").html("<p>"+ handType +" hand</p>");
		
		exercise = Object.keys(exercises)[0];
		$(".exDescription").append("<h3>"+ exercises[exercise].name +"</h3><p>"+ exercises[exercise].text +"</p>");
		$(".exDescription").append(exercises[exercise].picture);
		
		currWrkrDOM = $( ".action" ).first();
		$(currWrkrDOM).addClass( "active" );
		exerciseCounter = 0;
		exerciseRepeats = exercises[exercise].numRepeats;
		$("#exerciseRepeats").text(exerciseRepeats);
		
			//exercise = $(currWrkrDOM).attr( "id" );
		
		
	    controller.loop(function(frame) {
			if(exerciseCounter == 0){
				clear();
				draw_circle();
			}
			else if(exerciseCounter == exerciseRepeats && draw()){
				$(currWrkrDOM).removeClass( "active" ).addClass( "list-group-item-success");
				clear();
				draw_circle();
				
				next_wrkr();
			}
				
			for(i = 0, len = frame.hands.length; i < len; i++){
				hand = frame.hands[i];
				
				$(".progress-bar").attr({
					"aria-valuenow" : Math.round(hand.confidence*100),
					"style" : "width:" + Math.round(hand.confidence*100) + "%"  
				});
				
				if(handType.toLowerCase() === hand.type){
					$(".hand").removeClass("bg-danger").addClass("bg-success");
					exercises[exercise].exercise(frame);
				}else{
					$(".hand").removeClass("bg-success").addClass("bg-danger");
				}

				
			}
	
			draw();	
	    });

		draw_circle();
		
		
		return false;

	});

			
//	controller.on('frame', function(frame){
	/*
	////exercises here
	if(exercise == "twistsH"){

		exercises.twistsH.exercise();
	
		}
	/*else if(exercise == "twistsV"){

		wristNormal = Math.round(hand.palmNormal[2]);
		console.log(wristNormal +","+ oldNormal);
		if(wristNormal !== oldNormal && wristNormal != 1){
			exerciseCounter += 0.5;
			oldNormal = wristNormal;
		}

	
	}
		else if(exercise == "fist"){
		var fingerExt = 0; 
		for(j = 0, len1 = hand.fingers.length; j < len1; j++){
			finger = hand.fingers[j];
			if(finger.extended) 
				fingerExt ++;
		}
		if(fingerExt == 5){
			oldNormal = 1;
		}

		if(fingerExt <= 1 && hand.grabStrength == 1 && oldNormal == 1){
			exerciseCounter += 1;
			oldNormal = null;
		}
	}
			
	else if(exercise == "knuckle_bend"){
		exercises.knuckle_bend.exercise();
	}

	else if(exercise == "thumb_bend"){
		exercises.thumb_bend.exercise();

	}
	else if(exercise == "circle"){
		exercises.circle.exercise(frame);
	}
	
	
	*/
//	  });
	  
	
	//controller.connect();
	  
	 
    </script>

  </body>

</html>