<!DOCTYPE html>
<html lang="en">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leap</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
	
      body {
        line-height: 2em;
        font-size: 12pt;
        font-family: Helvetica;
      }
	  #output{
		  font-size: 18pt;
	  }
	  .jumbotron{
		  padding: 30px 0;
	  } 
	  .progress{
		  margin-bottom: 0px;
	  }
	  circle {
	    fill: #ddd;
	    stroke: #0074d9;
	    stroke-width: 50;
	    stroke-dasharray: 0 158;
	    transition: stroke-dasharray .3s ease;
		  
	  }

	  svg {
		transform: rotate(-90deg);
	    background: #ddd;
	    border-radius: 50%;
	  }
	  
    </style>

  </head>

  <body>
	  <div class="container">
	  	  <div class="jumbotron">
			  <h2>WRKR</h2>
	  		  <p>Welcome to wrist-fingers exerciser. You need a Leap Motion device to proceed. To start the daily exercise hit the button below.</p>
	          <p>
	            <a class="btn btn-lg btn-primary" href="#" role="button" id="start-wrkr">Start exercise</a>
	          </p>
	      </div>
	  	<div class="row">
	  		<div class="col-md-4">
					  <button id="twistsH" type="button" class="action list-group-item">Twists Horizontal</button>	  
					  <button id="twistsV" type="button" class="action list-group-item">Twists Vertical</button>
				<!-- <button id="fist" class="action">Fist stretch</button> -->
					  <button id="knuckle_bend" type="button" class="action list-group-item">Knuckle Bend</button>
					  <button id="thumb_bend" type="button" class="action list-group-item">Thumb Bend</button>
	  		</div>
			<div class="col-md-4">
				<p>Blah Blah Blah</p>
			</div>
			<div class="col-md-4">
				<div>You have done: <span id="exerciseProgress"></span>/5</div>
				<svg width="100" height="100" class="chart">
				    <circle r="25" cx="50" cy="50" id="pie"/>
				  </svg>
			</div>
	  	</div>
	  </div>
	 <!-- <div class="container-fluid">
		<div id="output"></div>
	  </div>
	  -->

<footer>
	<div class="progress navbar-fixed-bottom">
	  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
	    <span class="sr-only"></span>
	  </div>
	</div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="http://js.leapmotion.com/leap-0.6.3.js"></script>
<script>


	var counter = document.getElementById("exerciseProgress");
	var pie = document.getElementById("pie");
	
	var hand, finger;
	var extendedFingers = 0;
	var wristNormal, oldNormal = 0;
	var repDone = 1;
	var exerciseCounter = 0;
	var exercise;
	var total = 158;

	var numToPie = function(num){
	  var result = ((20 * num * total) / 100);
	  return result;
	}
	    
	//result = ;
  
	  
	

	/*
	function concat_data(id, data){
	
		return id + ": " + Math.round(data * 1000)/1000 + "</br>";
	}
	function concat_joint_position(id, position){
		return id + ": " + Math.round(position[0]) + ", " + Math.round(position[1]) + ", " + Math.round(position[2]) + "</br>";
	}
	*/
	var controller = new Leap.Controller({
	    enableGestures: true,
	    frameEventName: 'animationFrame'
	}), 
	callMuteRequestMade = false;
	
    
 	
	//var frameString = "";
	//var handString = " ";
	//var fingerString = "";
	//var output = document.getElementById("output");

	
	
	$(".action").click(function(){
		exercise = this.id;
		exerciseCounter = 0;
	});
	
	$("#start-wrkr").click(function(){
			var curr_wrkr = $( ".action" ).first();
			$(curr_wrkr).addClass( "active" );
			exerciseCounter = 0;
			exercise = $(curr_wrkr).attr( "id" );
		
		
		    controller.loop(function(frame) {
    			
				if(exerciseCounter == 5){
					$(curr_wrkr).removeClass( "active" );
					$(curr_wrkr).addClass( "list-group-item-success");
					
					
					find_wrkr();
				}
					
		    });
			
			function find_wrkr(){
				exerciseCounter = 0;
				
				next_wrkr = $(curr_wrkr).next();
				exercise = $(next_wrkr).attr( "id" );
				if(exercise === undefined){
					console.log("Done");
					return false;
				}
				$(next_wrkr).addClass( "active" );
				
				curr_wrkr = next_wrkr;
				
			}
			
			
			return false;

	});

			
	controller.on('frame', function(frame){
		
		
		//frameString = concat_data("num hands", frame.hands.length);
		for(i = 0, len = frame.hands.length; i < len; i++){
			hand = frame.hands[i];
			
			 /*  Debug mode 
			handString = "hand type: " + hand.type + "</br>";
			handString += concat_data("confidence", hand.confidence);
			
			handString += concat_data("pinch strength", hand.pinchStrength);
			handString += concat_data("grab strength", hand.grabStrength);
			handString += concat_joint_position("spere coordinates", hand.sphereCenter);
			handString += concat_data("sphere radius", hand.sphereRadius);
			handString += concat_joint_position("palm normal", hand.palmNormal);
			handString += "</br>";
			
			
			//frameString += concat_data("finger type", finger.type);
			for(j = 0, len1 = hand.fingers.length; j < len1; j++){
				
				finger = hand.fingers[j];
				fingerString = "finger " +  finger.type; 
				//handString += concat_data("finger type", finger.type);
				//handString += concat_joint_position("finger dip", finger.dipPosition);
				if(finger.extended){ 
						fingerString += " extended";
				}
				fingerString += "</br>";
				
				
				//if(finger.type >= 1 && finger.type <=4 && finger.extended == true){
			//		claw++;
			//	}
				
				
				
				handString += fingerString;
			}
			*/
			//frameString += handString;
			
		$(".progress-bar").attr({
			"aria-valuenow" : Math.round(hand.confidence*100),
			"style" : "width:" + Math.round(hand.confidence*100) + "%"  
		});
			////exercises here
			if(exercise == "twistsH"){
	
				wristNormal = Math.round(hand.palmNormal[1]);
				//console.log(wristNormal +","+ oldNormal);
				if(wristNormal !== oldNormal && wristNormal != -1){
					exerciseCounter += 0.5;
					oldNormal = wristNormal;
				}
				
				
			}else if(exercise == "twistsV"){
		
				wristNormal = Math.round(hand.palmNormal[2]);
				//console.log(wristNormal +","+ oldNormal);
				if(wristNormal !== oldNormal && wristNormal != 1){
					exerciseCounter += 0.5;
					oldNormal = wristNormal;
				}
			
				
			}/*
				else if(exercise == "fist"){
				var fingerExt = 0; 
				for(j = 0, len1 = hand.fingers.length; j < len1; j++){
					finger = hand.fingers[j];
					if(finger.extended) 
						fingerExt ++;
				}
				if(fingerExt == 5){
					oldNormal = 1;
				}

				if(fingerExt <= 1 && hand.grabStrength == 1 && oldNormal == 1){
					exerciseCounter += 1;
					oldNormal = null;
				}
				
			}*/
			else if(exercise == "knuckle_bend"){
				var clawState = 0;
				for(j = 0; j < hand.fingers.length; j++){
					finger = hand.fingers[j];
					if(finger.type >= 1 && finger.type <=4 && finger.extended == true){
						clawState++;
					}
				}
				if(clawState == 4)
					repDone = 0;
				
				else if(clawState == 0 && repDone == 0){
					exerciseCounter++;
					repDone = 1;
				}
				
			}
			else if(exercise == "thumb_bend"){
			
				if(hand.thumb.extended == true){
					repDone = 0;
				}
				
				if(hand.thumb.extended == false && repDone == 0){
					exerciseCounter++;
					repDone = 1;
				}
				
				
			}
			
		}
		
		counter.innerHTML = exerciseCounter;
		pie.style.strokeDasharray = numToPie(exerciseCounter) + ' ' + total;
		//output.innerHTML = frameString;  
	  });
	  
	
	controller.connect();
	  
	 
    </script>

  </body>

</html>